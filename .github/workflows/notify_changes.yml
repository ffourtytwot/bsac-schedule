name: Notify Schedule Changes

on:
  push:
    paths:
      - 'www/schedule.json' # –°–∞—á—ã—Ü—å –∑–∞ —Ñ–∞–π–ª–∞–º —Ä–∞—Å–∫–ª–∞–¥—É

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # –ö–∞–± –º–µ—Ü—å –¥–æ—Å—Ç—É–ø –¥–∞ –º—ñ–Ω—É–ª–∞–≥–∞ –∫–∞–º—ñ—Ç—É

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Firebase Admin SDK
        run: npm install firebase-admin

      - name: Detect Changes and Send Notification
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
        run: |
          node <<EOF
          const fs = require('fs');
          const { execSync } = require('child_process');
          const admin = require('firebase-admin');

          // 1. –ß—ã—Ç–∞–µ–º –Ω–æ–≤—ã —Ä–∞—Å–∫–ª–∞–¥
          const newSchedule = JSON.parse(fs.readFileSync('www/schedule.json', 'utf8'));

          // 2. –ß—ã—Ç–∞–µ–º —Å—Ç–∞—Ä—ã —Ä–∞—Å–∫–ª–∞–¥ (–ø—Ä–∞–∑ git)
          let oldSchedule = {};
          try {
            const oldContent = execSync('git show HEAD~1:www/schedule.json').toString();
            oldSchedule = JSON.parse(oldContent);
          } catch (e) {
            console.log("No previous version found or error reading it.");
          }

          // 3. –®—É–∫–∞–µ–º –∑–º–µ–Ω—ã
          const changedGroups = [];
          
          for (const group in newSchedule) {
            const newStr = JSON.stringify(newSchedule[group]);
            const oldStr = oldSchedule[group] ? JSON.stringify(oldSchedule[group]) : "";
            
            if (newStr !== oldStr) {
              changedGroups.push(group);
            }
          }

          if (changedGroups.length === 0) {
            console.log("No content changes detected.");
            process.exit(0);
          }

          const messageBody = "–ó–º–µ–Ω—ã —û –≥—Ä—É–ø–∞—Ö: " + changedGroups.join(", ");
          console.log("Sending notification:", messageBody);

          // 4. –ê–¥–ø—Ä–∞—û–ª—è–µ–º —É Firebase
          // –Ü–Ω—ñ—Ü—ã—è–ª—ñ–∑–∞—Ü—ã—è
          const serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT);
          
          admin.initializeApp({
            credential: admin.credential.cert(serviceAccount)
          });

          const message = {
            topic: 'all', // –®–ª–µ–º —É—Å—ñ–º, —Ö—Ç–æ –ø–∞–¥–ø—ñ—Å–∞—û—Å—è –Ω–∞ "all"
            notification: {
              title: 'üìÖ –†–∞—Å–∫–ª–∞–¥ –∞–±–Ω–æ—û–ª–µ–Ω—ã!',
              body: messageBody
            },
            android: {
              priority: 'high',
              notification: {
                sound: 'default'
              }
            }
          };

          admin.messaging().send(message)
            .then((response) => {
              console.log('Successfully sent message:', response);
              process.exit(0);
            })
            .catch((error) => {
              console.log('Error sending message:', error);
              process.exit(1);
            });
          EOF
